<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Soil Samples - Geotech Portfolio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:#071024;color:#fff;font-family:system-ui;padding:24px}
    .card{background:#0b2130;padding:12px;border-radius:10px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
    .muted{color:#9fb}
    .chip{background:#0f2634;padding:6px 10px;border-radius:999px;font-size:0.9rem}
    .detail{background:#071827;padding:12px;border-radius:8px}
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold">Soil Samples</h1>
        <div class="muted">All samples stored in the database</div>
      </div>
      <div class="flex gap-3">
        <a href="/" class="chip">Home</a>
        <a href="/gallery.html" class="chip">Gallery</a>
        <a href="/admin.html" class="chip">Admin</a>
        <a href="/test-dashboard.html" class="chip">Tests</a>
      </div>
    </header>

    <section>
      <div id="list" class="grid">Loading samples…</div>
    </section>

    <hr class="my-8 border-gray-700">

    <section>
      <h2 class="text-lg font-semibold mb-3">Selected sample</h2>
      <div id="detail" class="detail">No sample selected — click any sample card above.</div>
    </section>
  </div>

<script>
  // Supabase settings (same as your other pages)
  const SUPABASE_URL = "https://masgbgxihatymnqlwjej.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hc2diZ3hpaGF0eW1ucWx3amVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMDY0NTEsImV4cCI6MjA3ODc4MjQ1MX0.iVyY49idmzRy7r2ISFonQDCuBkIBycn-7Z7JbBxsVKQ";

  async function fetchSoils() {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/soils?select=*&order=created_at.desc`, {
      headers: { apikey: SUPABASE_ANON_KEY }
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  function renderList(samples) {
    const list = document.getElementById('list');
    list.innerHTML = '';
    if (!samples.length) { list.innerHTML = '<div class="muted">No samples yet. Use Admin to add.</div>'; return; }
    samples.forEach(s => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="flex justify-between items-start">
          <div>
            <div class="text-lg font-semibold">${escapeHtml(s.name || 'Unnamed')}</div>
            <div class="muted text-sm">ID: ${escapeHtml(s.sample_id || s.id)}</div>
          </div>
          <div class="text-right">
            <div style="background:${escapeHtml(s.color||'#2d2d2d')};width:56px;height:56px;border-radius:8px;box-shadow:inset 0 0 0 2px rgba(0,0,0,0.2)"></div>
          </div>
        </div>
        <div class="mt-3 text-sm text-gray-300">
          <div><strong>Location:</strong> ${escapeHtml(s.location || '')}</div>
          <div><strong>Texture:</strong> ${escapeHtml(s.texture || '')}</div>
        </div>
        <div class="mt-4 flex gap-2">
          <button data-id="${s.id}" class="view-btn" style="padding:8px 10px;border-radius:8px;background:#164e63;border:0;color:white;cursor:pointer">View</button>
          <a href="/test-dashboard.html?soil=${encodeURIComponent(s.id)}" class="chip">Open tests</a>
        </div>
      `;
      list.appendChild(card);
    });

    // attach view handlers
    Array.from(document.getElementsByClassName('view-btn')).forEach(btn=>{
      btn.onclick = () => {
        const id = btn.getAttribute('data-id');
        const sample = samples.find(x => x.id === id);
        showDetail(sample);
      };
    });
  }

  function showDetail(s) {
    if (!s) { document.getElementById('detail').innerText = 'No sample selected'; return; }
    document.getElementById('detail').innerHTML = `
      <div style="display:flex;gap:16px;align-items:flex-start">
        <div style="width:160px;flex-shrink:0">
          <div style="background:${escapeHtml(s.color||'#2d2d2d')};height:120px;border-radius:8px"></div>
        </div>
        <div style="flex:1">
          <h3 class="text-xl font-semibold">${escapeHtml(s.name||'Unnamed')}</h3>
          <div class="muted">Sample ID: ${escapeHtml(s.sample_id||s.id)}</div>
          <p style="margin-top:12px">${escapeHtml(s.description || 'No description')}</p>
          <div style="margin-top:12px" class="muted"><strong>Location:</strong> ${escapeHtml(s.location||'')}</div>
          <div style="margin-top:6px" class="muted"><strong>Texture:</strong> ${escapeHtml(s.texture||'')}</div>
        </div>
      </div>
    `;
  }

  // small helper to escape text
  function escapeHtml(t){ return (t===null||t===undefined)?'':String(t).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

  // init
  (async () => {
    try {
      const soils = await fetchSoils();
      renderList(soils);
      // if querystring has ?soil=ID open it
      const params = new URLSearchParams(window.location.search);
      const qs = params.get('soil');
      if (qs) {
        const found = soils.find(s=>s.id===qs || s.sample_id===qs);
        if (found) showDetail(found);
      }
    } catch (e) {
      document.getElementById('list').innerText = 'Error loading samples: ' + e.message;
      console.error(e);
    }
  })();
</script>
</body>
</html>
